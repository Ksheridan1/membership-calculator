<script>
const { jsPDF } = window.jspdf;

const getNum = (id) => Number.parseFloat(document.getElementById(id).value) || 0;
const asMoney = (val) =>
  new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(val);

// MASTER STATE (future Square / webhook ready)
const state = {
  rawInputs: {},
  frequencies: {},
  annualRetail: 0,
  annualMembership: 0,
  monthly: 0,
  activation: 0,
  membershipType: "custom"
};

let signaturePad = null;

/* ======================================================
   SIGNATURE CANVAS
====================================================== */
function resizeSigCanvas() {
  const canvas = document.getElementById("signaturePad");
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * ratio;
  canvas.height = rect.height * ratio;
  canvas.getContext("2d").setTransform(ratio, 0, 0, ratio, 0, 0);
  if (signaturePad) signaturePad.clear();
}

/* ======================================================
   CORE MEMBERSHIP CALCULATION ENGINE
====================================================== */
function calculate() {

  /* -------------------------------
     RAW INPUTS
  -------------------------------- */
  const raw = {
    softWash: getNum("softWash"),
    gutterFeet: getNum("gutterFeet"),
    gutterRate: getNum("gutterRate"),
    windowCount: getNum("windowCount"),
    windowRate: getNum("windowRate"),
    drivewayPrice: getNum("drivewayPrice"),
    waterMonthly: getNum("waterMonthly"),
    activation: getNum("activationFee")
  };

  /* -------------------------------
     FREQUENCIES (default = 1)
  -------------------------------- */
  const freq = {
    windows: 1,
    gutters: 1,
    softWash: 1,
    driveway: 1,
    water: raw.waterMonthly > 0 ? 1 : 0
  };

  /* -------------------------------
     ANNUAL SERVICE CALCULATIONS
  -------------------------------- */

  const annualWindows =
    raw.windowCount * raw.windowRate * freq.windows;

  const annualGutters =
    raw.gutterFeet * raw.gutterRate * freq.gutters;

  const annualSoftWash =
    raw.softWash * freq.softWash;

  const annualDriveway =
    raw.drivewayPrice * freq.driveway;

  // WATER FEATURE (9 months service, spread across 12)
  const annualWater =
    raw.waterMonthly > 0
      ? raw.waterMonthly * 9
      : 0;

  /* -------------------------------
     ANNUAL RETAIL TOTAL
  -------------------------------- */

  const annualRetail =
    annualWindows +
    annualGutters +
    annualSoftWash +
    annualDriveway +
    annualWater;

  /* -------------------------------
     FINANCING MODEL (NO DISCOUNT)
     15% Premium Built In
  -------------------------------- */

  const annualMembership =
    annualRetail * 1.15;

  const monthly =
    Math.ceil(annualMembership / 12);

  const yearOneTotal =
    raw.activation + annualMembership;

  /* -------------------------------
     UI OUTPUT
  -------------------------------- */

  document.getElementById("annualRetail").textContent =
    asMoney(annualRetail);

  document.getElementById("retailMonthly").textContent =
    asMoney(annualRetail / 12);

  document.getElementById("nonMemberMonthly").textContent =
    asMoney(annualRetail / 12);

  document.getElementById("memberMonthly").textContent =
    asMoney(monthly);

  document.getElementById("activationDisplay").textContent =
    asMoney(raw.activation);

  document.getElementById("yearOneTotal").textContent =
    asMoney(yearOneTotal);

  document.getElementById("annualSavings").textContent =
    "Financing & Convenience Premium Included";

  document.getElementById("results").style.display = "block";
  document.getElementById("openContractBtn").disabled = false;

  /* -------------------------------
     SAVE STATE
  -------------------------------- */

  state.rawInputs = raw;
  state.frequencies = freq;
  state.annualRetail = annualRetail;
  state.annualMembership = annualMembership;
  state.monthly = monthly;
  state.activation = raw.activation;

  localStorage.setItem("hydroblast_state", JSON.stringify(state));
}

/* ======================================================
   LOAD SAVED DATA (refresh safe)
====================================================== */
window.addEventListener("load", () => {
  const saved = localStorage.getItem("hydroblast_state");
  if (!saved) return;

  const parsed = JSON.parse(saved);

  if (parsed.rawInputs) {
    Object.keys(parsed.rawInputs).forEach(key => {
      const el = document.getElementById(key);
      if (el) el.value = parsed.rawInputs[key];
    });
  }

  calculate();
});

/* ======================================================
   CONTRACT LOGIC
====================================================== */
function openContract() {
  if (!state.monthly) {
    alert("Please calculate pricing first.");
    return;
  }

  alert("Membership not valid until activation fee is processed through Square.");

  const name = document.getElementById("clientName").value.trim();
  const address = document.getElementById("clientAddress").value.trim();

  if (!name || !address) {
    alert("Please enter client name and address.");
    return;
  }

  document.getElementById("sumClient").textContent = name;
  document.getElementById("sumAddress").textContent = address;
  document.getElementById("sumDate").textContent = new Date().toLocaleDateString();
  document.getElementById("sumActivation").textContent = asMoney(state.activation);
  document.getElementById("sumMonthly").textContent = asMoney(state.monthly);
  document.getElementById("sumRetailMonthly").textContent =
    asMoney(state.annualRetail / 12);
  document.getElementById("sumNonMemberMonthly").textContent =
    asMoney(state.annualRetail / 12);

  document.getElementById("contractModal").style.display = "flex";

  signaturePad = new SignaturePad(document.getElementById("signaturePad"));
  resizeSigCanvas();
  document.getElementById("agreeBox").checked = false;
}

function closeContract() {
  document.getElementById("contractModal").style.display = "none";
}

function clearSignature() {
  if (signaturePad) signaturePad.clear();
}

/* ======================================================
   BUTTON WIRING
====================================================== */

document.getElementById("calculateBtn").addEventListener("click", calculate);
document.getElementById("openContractBtn").addEventListener("click", openContract);
document.getElementById("closeModalBtn").addEventListener("click", closeContract);
document.getElementById("clearSigBtn").addEventListener("click", clearSignature);

window.addEventListener("resize", () => {
  if (document.getElementById("contractModal").style.display === "flex") {
    resizeSigCanvas();
  }
});

document.getElementById("contractModal").addEventListener("click", (e) => {
  if (e.target.id === "contractModal") closeContract();
});
</script>
