<script>
/* ===============================
   GLOBAL STATE
================================ */
const { jsPDF } = window.jspdf;

const state = {
  client: {},
  rawInputs: {},
  frequencies: {},
  annualRetail: 0,
  annualMembership: 0,
  monthly: 0,
  activation: 0,
  membershipType: "basic"
};

let signaturePad = null;

/* ===============================
   HELPERS
================================ */
const getNum = (id) => Number.parseFloat(document.getElementById(id)?.value) || 0;
const asMoney = (val) => new Intl.NumberFormat("en-US", {
  style: "currency",
  currency: "USD"
}).format(val);

/* ===============================
   MEMBERSHIP PRESETS
================================ */
function applyMembershipPreset(type) {
  const presets = {
    basic: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 0,
      drivewayFrequency: 0,
      poolFrequency: 0
    },
    homeShield: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 1,
      drivewayFrequency: 0,
      poolFrequency: 0
    },
    elite: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 1,
      drivewayFrequency: 1,
      poolFrequency: 1
    },
    custom: {
      windowFrequency: 0,
      gutterFrequency: 0,
      softWashFrequency: 0,
      drivewayFrequency: 0,
      poolFrequency: 0
    }
  };

  const selected = presets[type] || presets.custom;

  Object.keys(selected).forEach(key => {
    const el = document.getElementById(key);
    if (el) el.value = selected[key];
  });
}

/* ===============================
   MAIN CALCULATION ENGINE
================================ */
function calculate() {

  /* ---- Client Info ---- */
  state.client = {
    name: document.getElementById("clientName")?.value || "",
    address: document.getElementById("clientAddress")?.value || "",
    date: new Date().toLocaleDateString()
  };

  /* ---- Raw Inputs ---- */
  state.rawInputs = {
    windowCount: getNum("windowCount"),
    windowRate: getNum("windowRate"),
    gutterFeet: getNum("gutterFeet"),
    gutterRate: getNum("gutterRate"),
    softWash: getNum("softWash"),
    drivewayPrice: getNum("drivewayPrice"),
    poolPrice: getNum("poolPrice"),
    waterMonthly: getNum("waterMonthly"),
    hourlyRate: getNum("hourlyRate"),
    openCloseHours: getNum("openCloseHours")
  };

  /* ---- Frequencies ---- */
  state.frequencies = {
    windowFrequency: getNum("windowFrequency"),
    gutterFrequency: getNum("gutterFrequency"),
    softWashFrequency: getNum("softWashFrequency"),
    drivewayFrequency: getNum("drivewayFrequency"),
    poolFrequency: getNum("poolFrequency")
  };

  /* ---- Water Logic ---- */
  const waterEnabled = document.getElementById("waterEnabled")?.value == "1";

  const annualWaterMaintenance =
    state.rawInputs.waterMonthly * 9;

  const annualOpenClose =
    state.rawInputs.hourlyRate *
    state.rawInputs.openCloseHours * 2;

  const annualWater =
    waterEnabled ? (annualWaterMaintenance + annualOpenClose) : 0;

  /* ---- Annual Retail ---- */
  const annualWindows =
    state.rawInputs.windowCount *
    state.rawInputs.windowRate *
    state.frequencies.windowFrequency;

  const annualGutters =
    state.rawInputs.gutterFeet *
    state.rawInputs.gutterRate *
    state.frequencies.gutterFrequency;

  const annualSoftWash =
    state.rawInputs.softWash *
    state.frequencies.softWashFrequency;

  const annualDriveway =
    state.rawInputs.drivewayPrice *
    state.frequencies.drivewayFrequency;

  const annualPool =
    state.rawInputs.poolPrice *
    state.frequencies.poolFrequency;

  state.annualRetail =
    annualWindows +
    annualGutters +
    annualSoftWash +
    annualDriveway +
    annualPool +
    annualWater;

  /* ---- Membership Premium ---- */
  state.annualMembership =
    state.annualRetail * 1.15;

  /* ---- Monthly Rounded UP ---- */
  state.monthly =
    Math.ceil(state.annualMembership / 12);

  /* ---- Activation ---- */
  state.activation =
    getNum("activationFee");

  const yearOne =
    state.activation + state.annualMembership;

  /* ---- Display ---- */
  document.getElementById("annualRetail").textContent =
    asMoney(state.annualRetail);

  document.getElementById("annualMembership").textContent =
    asMoney(state.annualMembership);

  document.getElementById("memberMonthly").textContent =
    asMoney(state.monthly);

  document.getElementById("activationDisplay").textContent =
    asMoney(state.activation);

  document.getElementById("yearOneTotal").textContent =
    asMoney(yearOne);

  document.getElementById("results").style.display = "block";
  document.getElementById("openContractBtn").disabled = false;
}

/* ===============================
   CONTRACT + SIGNATURE
================================ */
function openContract() {

  if (!state.client.name || !state.client.address) {
    alert("Enter client name and address first.");
    return;
  }

  alert("Membership not valid until activation fee is processed through Square.");

  document.getElementById("sumClient").textContent =
    state.client.name;

  document.getElementById("sumAddress").textContent =
    state.client.address;

  document.getElementById("sumDate").textContent =
    state.client.date;

  document.getElementById("sumActivation").textContent =
    asMoney(state.activation);

  document.getElementById("sumMonthly").textContent =
    asMoney(state.monthly);

  document.getElementById("sumRetailMonthly").textContent =
    asMoney(state.annualRetail / 12);

  document.getElementById("sumNonMemberMonthly").textContent =
    asMoney(state.annualRetail * 1.15 / 12);

  document.getElementById("contractModal").style.display = "flex";

  signaturePad = new SignaturePad(
    document.getElementById("signaturePad")
  );
}

function generateSignedPDF() {

  if (!document.getElementById("agreeBox").checked) {
    alert("Client must agree to terms.");
    return;
  }

  if (!signaturePad || signaturePad.isEmpty()) {
    alert("Signature required.");
    return;
  }

  const doc = new jsPDF();
  let y = 20;

  doc.text("HydroBlast Membership Agreement", 20, y);
  y += 10;
  doc.text(`Client: ${state.client.name}`, 20, y);
  y += 10;
  doc.text(`Address: ${state.client.address}`, 20, y);
  y += 10;
  doc.text(`Monthly: ${asMoney(state.monthly)}`, 20, y);
  y += 10;
  doc.text(`Activation: ${asMoney(state.activation)}`, 20, y);

  doc.addImage(
    signaturePad.toDataURL(),
    "PNG",
    20,
    y + 10,
    120,
    40
  );

  doc.save(
    state.client.name.replace(/\s/g, "_") +
    "_HydroBlast_Membership.pdf"
  );
}

/* ===============================
   EVENT LISTENERS
================================ */
document.getElementById("calculateBtn")
  .addEventListener("click", calculate);

document.getElementById("openContractBtn")
  .addEventListener("click", openContract);

document.getElementById("generatePdfBtn")
  .addEventListener("click", generateSignedPDF);

document.getElementById("membershipType")
  .addEventListener("change", (e) => {
    applyMembershipPreset(e.target.value);
    calculate();
  });

document.getElementById("activationFee")
  .addEventListener("change", calculate);

</script>




