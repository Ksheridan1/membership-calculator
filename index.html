<script>
const { jsPDF } = window.jspdf;
const getNum = (id) => Number.parseFloat(document.getElementById(id)?.value) || 0;
const asMoney = (val) => new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" }).format(val);

/* ============================
   GLOBAL STATE
============================ */
const state = {
  client: {},
  rawInputs: {},
  frequencies: {},
  annualRetail: 0,
  annualMembership: 0,
  monthly: 0,
  activation: 0,
  membershipType: "basic"
};

let signaturePad = null;

/* ============================
   PHASE 1 → DATA COLLECTION
============================ */
function collectClientData() {
  const name = document.getElementById("clientName").value.trim();
  const address = document.getElementById("clientAddress").value.trim();

  if (!name || !address) {
    alert("Enter client name and address first.");
    return false;
  }

  state.client = {
    name,
    address,
    date: new Date().toISOString()
  };

  document.getElementById("membershipSection").style.display = "block";
  return true;
}

/* ============================
   PHASE 2 → CALCULATION ENGINE
============================ */
function calculate() {

  // RAW INPUTS
  const rawInputs = {
    windowCount: getNum("windowCount"),
    windowRate: getNum("windowRate"),
    gutterFeet: getNum("gutterFeet"),
    gutterRate: getNum("gutterRate"),
    softWash: getNum("softWash"),
    drivewayPrice: getNum("drivewayPrice"),
    poolPrice: getNum("poolPrice"),
    waterMonthly: getNum("waterMonthly"),
    hourlyRate: getNum("hourlyRate"),
    openCloseHours: getNum("openCloseHours")
  };

  // FREQUENCIES
  const frequencies = {
    windowFrequency: getNum("windowFrequency"),
    gutterFrequency: getNum("gutterFrequency"),
    softWashFrequency: getNum("softWashFrequency"),
    drivewayFrequency: getNum("drivewayFrequency"),
    poolFrequency: getNum("poolFrequency")
  };

  const waterEnabled = getNum("waterEnabled") === 1;

  // WATER LOGIC
  const annualWaterMaintenance = rawInputs.waterMonthly * 9;
  const annualOpenClose = rawInputs.hourlyRate * rawInputs.openCloseHours * 2;
  const annualWaterTotal = waterEnabled ? (annualWaterMaintenance + annualOpenClose) : 0;

  // STEP 1 – BASE SERVICES
  const annualWindows = rawInputs.windowCount * rawInputs.windowRate * frequencies.windowFrequency;
  const annualGutters = rawInputs.gutterFeet * rawInputs.gutterRate * frequencies.gutterFrequency;
  const annualSoftWash = rawInputs.softWash * frequencies.softWashFrequency;
  const annualDriveway = rawInputs.drivewayPrice * frequencies.drivewayFrequency;
  const annualPool = rawInputs.poolPrice * frequencies.poolFrequency;

  // STEP 2 – ANNUAL RETAIL
  const annualRetail =
    annualWindows +
    annualGutters +
    annualSoftWash +
    annualDriveway +
    annualPool +
    annualWaterTotal;

  // STEP 3 – FINANCING PREMIUM (LOCKED 15%)
  const annualMembership = annualRetail * 1.15;

  // STEP 4 – MONTHLY ROUNDED UP
  const monthly = Math.ceil(annualMembership / 12);

  // STEP 5 – ACTIVATION
  const activation = getNum("activationFee");
  const yearOneTotal = activation + annualMembership;

  // STORE STATE
  state.rawInputs = rawInputs;
  state.frequencies = frequencies;
  state.annualRetail = annualRetail;
  state.annualMembership = annualMembership;
  state.monthly = monthly;
  state.activation = activation;
  state.membershipType = document.getElementById("membershipType").value;

  // DISPLAY
  document.getElementById("annualRetail").textContent = asMoney(annualRetail);
  document.getElementById("annualMembership").textContent = asMoney(annualMembership);
  document.getElementById("memberMonthly").textContent = asMoney(monthly);
  document.getElementById("activationDisplay").textContent = asMoney(activation);
  document.getElementById("yearOneTotal").textContent = asMoney(yearOneTotal);

  document.getElementById("results").style.display = "block";
  document.getElementById("openContractBtn").disabled = false;
}

/* ============================
   MEMBERSHIP PRESETS
============================ */
function applyMembershipPreset(type) {

  const presets = {
    basic: { windowFrequency:2, gutterFrequency:1, softWashFrequency:0, drivewayFrequency:0, poolFrequency:0, waterEnabled:0 },
    homeShield: { windowFrequency:2, gutterFrequency:1, softWashFrequency:1, drivewayFrequency:0, poolFrequency:0, waterEnabled:0 },
    elite: { windowFrequency:2, gutterFrequency:1, softWashFrequency:1, drivewayFrequency:1, poolFrequency:1, waterEnabled:1 },
    custom: { windowFrequency:0, gutterFrequency:0, softWashFrequency:0, drivewayFrequency:0, poolFrequency:0, waterEnabled:0 }
  };

  const preset = presets[type] || presets.custom;

  Object.entries(preset).forEach(([id,val])=>{
    const el = document.getElementById(id);
    if(el) el.value = val;
  });

  calculate();
}

/* ============================
   PHASE 3 → CONTRACT
============================ */
function openContract() {

  if (!state.client.name) {
    alert("Complete client data first.");
    return;
  }

  alert("Membership not valid until activation fee is processed through Square.");

  document.getElementById("sumClient").textContent = state.client.name;
  document.getElementById("sumAddress").textContent = state.client.address;
  document.getElementById("sumDate").textContent = new Date().toLocaleDateString();
  document.getElementById("sumActivation").textContent = asMoney(state.activation);
  document.getElementById("sumMonthly").textContent = asMoney(state.monthly);

  document.getElementById("contractModal").style.display = "flex";
  signaturePad = new SignaturePad(document.getElementById("signaturePad"));
}

/* ============================
   PDF GENERATION
============================ */
function generateSignedPDF() {

  if (!document.getElementById("agreeBox").checked)
    return alert("Client must agree.");

  if (!signaturePad || signaturePad.isEmpty())
    return alert("Signature required.");

  const doc = new jsPDF();
  let y = 20;

  doc.text("HydroBlast Membership Agreement", 20, y); y+=10;
  doc.text(`Client: ${state.client.name}`,20,y); y+=10;
  doc.text(`Address: ${state.client.address}`,20,y); y+=10;
  doc.text(`Annual Retail: ${asMoney(state.annualRetail)}`,20,y); y+=10;
  doc.text(`Annual Membership: ${asMoney(state.annualMembership)}`,20,y); y+=10;
  doc.text(`Monthly: ${asMoney(state.monthly)}`,20,y); y+=10;
  doc.text(`Activation: ${asMoney(state.activation)}`,20,y); y+=10;

  doc.addImage(signaturePad.toDataURL(),"PNG",20,y,100,40);
  doc.save(`${state.client.name}_Membership.pdf`);
}

/* ============================
   AUTO LISTENERS
============================ */

[
  "windowCount","windowRate","gutterFeet","gutterRate",
  "softWash","drivewayPrice","poolPrice",
  "waterMonthly","hourlyRate","openCloseHours",
  "windowFrequency","gutterFrequency","softWashFrequency",
  "drivewayFrequency","poolFrequency",
  "waterEnabled","activationFee"
].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener("change", calculate);
});

document.getElementById("membershipType")
  .addEventListener("change", e=>applyMembershipPreset(e.target.value));

document.getElementById("calculateBtn").addEventListener("click", calculate);
document.getElementById("openContractBtn").addEventListener("click", openContract);
document.getElementById("generatePdfBtn").addEventListener("click", generateSignedPDF);
</script>




