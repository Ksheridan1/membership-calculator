<script>
/* ==========================================================
   HYDROBLAST MEMBERSHIP ENGINE – PRODUCTION BUILD
   ========================================================== */

const { jsPDF } = window.jspdf;

/* ===========================
   GLOBAL CONSTANTS
=========================== */

const FINANCING_PREMIUM = 0.15; // 15%
const WATER_MONTHS_ACTIVE = 9;
const MONTHS_IN_YEAR = 12;

/* ===========================
   STATE MANAGEMENT
=========================== */

const state = {
  rawInputs: {},
  frequencies: {},
  annualRetail: 0,
  annualMembership: 0,
  monthly: 0,
  activation: 0,
  membershipType: "basic"
};

/* ===========================
   HELPERS
=========================== */

const getNum = (id) =>
  Number.parseFloat(document.getElementById(id)?.value) || 0;

const asMoney = (val) =>
  new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(val);

function saveState() {
  localStorage.setItem("hb_membership_state", JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem("hb_membership_state");
  if (!saved) return;
  const parsed = JSON.parse(saved);

  Object.assign(state, parsed);

  // Restore inputs
  Object.entries(parsed.rawInputs || {}).forEach(([k, v]) => {
    const el = document.getElementById(k);
    if (el) el.value = v;
  });

  Object.entries(parsed.frequencies || {}).forEach(([k, v]) => {
    const el = document.getElementById(k);
    if (el) el.value = v;
  });

  document.getElementById("activationFee").value = parsed.activation || 199;
  document.getElementById("membershipType").value =
    parsed.membershipType || "basic";

  calculate();
}

/* ===========================
   MEMBERSHIP PRESETS
=========================== */

function applyPreset(type) {
  const presets = {
    basic: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 0,
      drivewayFrequency: 0,
      poolFrequency: 0,
      waterEnabled: false,
    },
    homeShield: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 1,
      drivewayFrequency: 0,
      poolFrequency: 0,
      waterEnabled: false,
    },
    elite: {
      windowFrequency: 2,
      gutterFrequency: 1,
      softWashFrequency: 1,
      drivewayFrequency: 1,
      poolFrequency: 1,
      waterEnabled: true,
    },
    custom: {
      windowFrequency: 0,
      gutterFrequency: 0,
      softWashFrequency: 0,
      drivewayFrequency: 0,
      poolFrequency: 0,
      waterEnabled: false,
    },
  };

  const p = presets[type] || presets.custom;

  Object.entries(p).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) {
      if (el.type === "checkbox") {
        el.checked = val;
      } else {
        el.value = val;
      }
    }
  });

  state.membershipType = type;
  calculate();
}

/* ===========================
   CORE CALCULATION ENGINE
=========================== */

function calculate() {
  /* -------------------------
     RAW INPUT CAPTURE
  -------------------------- */

  const rawInputs = {
    windowCount: getNum("windowCount"),
    windowRate: getNum("windowRate"),
    gutterFeet: getNum("gutterFeet"),
    gutterRate: getNum("gutterRate"),
    softWash: getNum("softWash"),
    drivewayPrice: getNum("drivewayPrice"),
    poolPrice: getNum("poolPrice"),
    waterMonthly: getNum("waterMonthly"),
    hourlyRate: getNum("hourlyRate"),
    openCloseHours: getNum("openCloseHours"),
  };

  const frequencies = {
    windowFrequency: getNum("windowFrequency"),
    gutterFrequency: getNum("gutterFrequency"),
    softWashFrequency: getNum("softWashFrequency"),
    drivewayFrequency: getNum("drivewayFrequency"),
    poolFrequency: getNum("poolFrequency"),
  };

  const waterEnabled =
    document.getElementById("waterEnabled")?.checked || false;

  /* -------------------------
     SERVICE CALCULATIONS
  -------------------------- */

  const annualWindows =
    rawInputs.windowCount *
    rawInputs.windowRate *
    frequencies.windowFrequency;

  const annualGutters =
    rawInputs.gutterFeet *
    rawInputs.gutterRate *
    frequencies.gutterFrequency;

  const annualSoftWash =
    rawInputs.softWash * frequencies.softWashFrequency;

  const annualDriveway =
    rawInputs.drivewayPrice * frequencies.drivewayFrequency;

  const annualPool =
    rawInputs.poolPrice * frequencies.poolFrequency;

  const annualWaterMaintenance =
    rawInputs.waterMonthly * WATER_MONTHS_ACTIVE;

  const annualOpenClose =
    rawInputs.hourlyRate *
    rawInputs.openCloseHours *
    2;

  const annualWater =
    waterEnabled
      ? annualWaterMaintenance + annualOpenClose
      : 0;

  /* -------------------------
     STEP 2 — ANNUAL RETAIL
  -------------------------- */

  const annualRetail =
    annualWindows +
    annualGutters +
    annualSoftWash +
    annualDriveway +
    annualPool +
    annualWater;

  /* -------------------------
     STEP 3 — FINANCING PREMIUM
  -------------------------- */

  const annualMembership =
    annualRetail * (1 + FINANCING_PREMIUM);

  /* -------------------------
     STEP 4 — MONTHLY
  -------------------------- */

  const monthly =
    Math.ceil(annualMembership / MONTHS_IN_YEAR);

  /* -------------------------
     STEP 5 — YEAR 1
  -------------------------- */

  const activation = getNum("activationFee");
  const yearOneTotal = activation + annualMembership;

  /* -------------------------
     UPDATE STATE
  -------------------------- */

  state.rawInputs = rawInputs;
  state.frequencies = frequencies;
  state.annualRetail = annualRetail;
  state.annualMembership = annualMembership;
  state.monthly = monthly;
  state.activation = activation;

  saveState();

  /* -------------------------
     UI OUTPUT
  -------------------------- */

  document.getElementById("annualRetail").textContent =
    asMoney(annualRetail);

  document.getElementById("annualMembership").textContent =
    asMoney(annualMembership);

  document.getElementById("memberMonthly").textContent =
    asMoney(monthly);

  document.getElementById("activationDisplay").textContent =
    asMoney(activation);

  document.getElementById("yearOneTotal").textContent =
    asMoney(yearOneTotal);

  document.getElementById("results").style.display = "block";
  document.getElementById("openContractBtn").disabled = false;
}

/* ===========================
   CONTRACT
=========================== */

function openContract() {
  alert(
    "Membership not valid until activation fee is processed through Square."
  );

  const name =
    document.getElementById("clientName").value.trim();
  const address =
    document.getElementById("clientAddress").value.trim();

  if (!name || !address) {
    alert("Client name and address required.");
    return;
  }

  document.getElementById("sumClient").textContent = name;
  document.getElementById("sumAddress").textContent = address;
  document.getElementById("sumDate").textContent =
    new Date().toLocaleDateString();
  document.getElementById("sumActivation").textContent =
    asMoney(state.activation);
  document.getElementById("sumMonthly").textContent =
    asMoney(state.monthly);

  document.getElementById("contractModal").style.display =
    "flex";
}

/* ===========================
   EVENT WIRING
=========================== */

document
  .querySelectorAll("input, select")
  .forEach((el) => {
    el.addEventListener("change", calculate);
    el.addEventListener("input", calculate);
  });

document
  .getElementById("membershipType")
  .addEventListener("change", (e) =>
    applyPreset(e.target.value)
  );

document
  .getElementById("openContractBtn")
  .addEventListener("click", openContract);

document
  .getElementById("calculateBtn")
  .addEventListener("click", calculate);

/* ===========================
   INITIALIZE
=========================== */

loadState();
</script>
